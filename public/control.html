<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Controller</title>
    <style>
        body { font-family: sans-serif; background: #111; color: white; text-align: center; padding: 20px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        button { padding: 20px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; color: white; font-weight: bold;}
        .loc-btn { background: #333; border: 1px solid #444; }
        .loc-btn:active { background: #555; }
        .alert-btn { background: #d32f2f; grid-column: span 2; }
        input { width: 100%; padding: 15px; border-radius: 8px; border: none; margin-bottom: 15px; box-sizing: border-box; background: #222; color: white; border: 1px solid #444;}
        #status { margin-top: 10px; color: #888; font-size: 12px;}
    </style>
</head>
<body>
    <h3>DASHBOARD CONTROLLER</h3>
    
    <input type="password" id="pinCode" placeholder="Enter PIN (1234)" value="">

    <input type="text" id="customMsg" placeholder="Custom message...">
    <button onclick="sendUpdate(document.getElementById('customMsg').value)" style="width:100%; background:#2196F3; margin-bottom:20px; padding: 15px; border-radius: 8px; border:none; color:white;">Send Text</button>

    <div class="btn-grid">
        <button class="loc-btn" onclick="sendUpdate('üè† At Home')">üè† Home</button>
        <button class="loc-btn" onclick="sendUpdate('üéì At College')">üéì College</button>
        <button class="loc-btn" onclick="sendUpdate('üçî Getting Food')">üçî Food</button>
        <button class="loc-btn" onclick="sendUpdate('üöó Driving')">üöó Driving</button>
        <button class="alert-btn" onclick="sendAlert()">üö® SEND ALERT üö®</button>
    </div>

    <p id="status">Ready</p>

    <script>
        async function sendData(payload) {
            // GET PIN
            const pin = document.getElementById('pinCode').value;
            if(!pin) { alert("Enter PIN first!"); return; }
            payload.pin = pin;

            document.getElementById('status').innerText = "Getting Location...";
            
            try {
                if (navigator.geolocation) {
                     navigator.geolocation.getCurrentPosition(async (position) => {
                        payload.lat = position.coords.latitude;
                        payload.lon = position.coords.longitude;
                        await postToServer(payload);
                     }, async () => {
                        await postToServer(payload);
                     });
                } else {
                    await postToServer(payload);
                }
            } catch (e) {
                document.getElementById('status').innerText = "Error!";
            }
        }

        async function postToServer(payload) {
            document.getElementById('status').innerText = "Sending...";
            const res = await fetch('/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if(res.status === 401) {
                document.getElementById('status').innerText = "WRONG PIN!";
                alert("Wrong PIN!");
            } else {
                document.getElementById('status').innerText = "Sent: " + (payload.msg || "Alert");
            }
        }

        function sendUpdate(msg) { sendData({ msg: msg, alert: false }); }
        function sendAlert() { sendData({ msg: "HELP", alert: true }); }
    </script>
</body>
</html>
